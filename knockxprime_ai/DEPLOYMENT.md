# KnockXPrime AI Backend - Render Deployment Guide

## ğŸš€ Deployment Configuration

### Root Directory
```
knockxprime_ai/
```

### Build Command
```bash
pip install -r requirements.txt
```

### Start Command
```bash
uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

## ğŸ“‹ Environment Variables Required

Set these in your Render dashboard:

### Required Variables
- `NEON_API_URL` - Your Neon database REST API URL
- `NEON_API_KEY` - Your Neon database API key
- `GROK_API_KEY` - Your Grok API key for AI functionality
- `SECRET_KEY` - JWT secret key (auto-generated by Render)
- `RENDER_EXTERNAL_URL` - Your Render service URL (e.g., https://your-service.onrender.com)

### Optional Variables
- `ENVIRONMENT` - Set to "production" (default)
- `RATE_LIMIT_REQUESTS` - Requests per minute (default: 100)
- `RATE_LIMIT_WINDOW` - Rate limit window in seconds (default: 60)

## ğŸ—ï¸ Architecture Overview

### Middleware Stack
1. **Security Headers** - HSTS, CSP, XSS protection
2. **Request Logging** - Request tracking and monitoring
3. **Rate Limiting** - 100 requests/minute per IP
4. **CORS** - Cross-origin resource sharing

### API Endpoints
- `/health/` - Health check and keep-alive
- `/api/v1/users` - User management
- `/api/v1/chat` - AI chat functionality
- `/api/v1/usage` - Usage tracking
- `/api/v1/plans` - Subscription plans
- `/api/v1/admin` - Admin functions

### Database Integration
- **Neon PostgreSQL 15** via REST API
- **Daily usage tracking** with automatic reset
- **Subscription management** with 4-tier pricing
- **User authentication** with JWT tokens

## ğŸ’° Pricing Plans

| Plan Name | Price | Max Tokens | Max Requests | Notes |
|-----------|-------|------------|--------------|-------|
| Baby Free | $0    | 1,000      | 10/day       | Free limited plan |
| Leveler   | $4    | 5,000      | 100/day      | Paid |
| Log Min   | $10   | 20,000     | 500/day      | Paid |
| High Max  | $100  | 100,000    | 2,000/day    | Paid |

## ğŸ”§ Production Features

### Security
- Security headers (HSTS, CSP, XSS protection)
- Rate limiting per IP address
- CORS configuration for production domains
- Request ID tracking
- Input validation and sanitization

### Monitoring
- Request logging with timing
- Health check endpoint
- Rate limit headers
- Error tracking
- Performance metrics

### Scalability
- Stateless design
- Database connection pooling
- Async request handling
- Horizontal scaling ready

## ğŸ“ File Structure

```
knockxprime_ai/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI application
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py        # Configuration settings
â”‚   â”‚   â”œâ”€â”€ database.py      # Neon DB integration
â”‚   â”‚   â”œâ”€â”€ auth.py          # Authentication
â”‚   â”‚   â””â”€â”€ keep_alive.py    # Health checks
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ security.py      # Security headers
â”‚   â”‚   â”œâ”€â”€ logging.py       # Request logging
â”‚   â”‚   â”œâ”€â”€ rate_limiting.py # Rate limiting
â”‚   â”‚   â””â”€â”€ cors.py          # CORS configuration
â”‚   â”œâ”€â”€ api/v1/
â”‚   â”‚   â”œâ”€â”€ chat.py          # AI chat endpoints
â”‚   â”‚   â”œâ”€â”€ users.py         # User management
â”‚   â”‚   â”œâ”€â”€ usage.py         # Usage tracking
â”‚   â”‚   â”œâ”€â”€ plans.py         # Subscription plans
â”‚   â”‚   â””â”€â”€ admin.py         # Admin functions
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ grok_service.py  # Grok API integration
â”‚       â”œâ”€â”€ usage_service.py # Usage tracking
â”‚       â””â”€â”€ billing_guard.py # Plan enforcement
â”œâ”€â”€ requirements.txt         # Python dependencies
â”œâ”€â”€ render.yaml             # Render configuration
â”œâ”€â”€ Procfile               # Process configuration
â”œâ”€â”€ gunicorn.conf.py       # Gunicorn settings
â””â”€â”€ test_deployment.py     # Deployment test script

```

## ğŸ§ª Testing Deployment

Run the test script to verify everything is configured correctly:

```bash
python test_deployment.py
```

## ğŸŒ Health Check

The application provides a health check endpoint at `/health/` that:
- Returns 200 OK when healthy
- Includes system information
- Supports keep-alive functionality for Render

## ğŸ”„ Keep-Alive System

The backend includes a keep-alive system that:
- Prevents Render free tier from sleeping
- Pings your service URL every 3 seconds when active
- Uses the RENDER_EXTERNAL_URL environment variable
- Minimal resource usage
- No interference with main functionality

**Setup**: Set `RENDER_EXTERNAL_URL` to your Render service URL (e.g., `https://your-service.onrender.com`)

## ğŸ“Š Monitoring & Logs

### Request Logging
- All requests logged with timing
- Client IP tracking
- Error logging
- Request ID correlation

### Rate Limiting
- 100 requests per minute per IP
- Sliding window algorithm
- Rate limit headers in responses
- Graceful error handling

### Security Monitoring
- Security headers on all responses
- CORS policy enforcement
- XSS and CSRF protection
- Content type validation

## ğŸš¨ Troubleshooting

### Common Issues
1. **Import Errors** - Run `pip install -r requirements.txt`
2. **Database Connection** - Check NEON_API_URL and NEON_API_KEY
3. **CORS Issues** - Verify allowed origins in production
4. **Rate Limiting** - Check client IP detection

### Debug Mode
Set `ENVIRONMENT=development` to enable:
- API documentation at `/docs`
- Detailed error messages
- Development CORS settings

## ğŸ“ˆ Performance

### Optimizations
- Async request handling
- Connection pooling
- Middleware ordering
- Response compression
- Static file serving

### Scaling
- Stateless design allows horizontal scaling
- Database operations via REST API
- No local file dependencies
- Environment-based configuration

## ğŸ” Security Checklist

- âœ… Environment variables for secrets
- âœ… Password hashing (bcrypt)
- âœ… JWT token authentication
- âœ… Rate limiting implemented
- âœ… CORS properly configured
- âœ… Security headers added
- âœ… Input validation
- âœ… SQL injection prevention
- âœ… XSS protection
- âœ… CSRF protection

## ğŸ“ Support

For deployment issues or questions:
1. Check the logs in Render dashboard
2. Verify environment variables
3. Test with the deployment script
4. Review the health check endpoint